<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demir Kırtasiye Transfer İrsaliye Hazırlama</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fa; text-align: center; padding: 20px; }
    h1 { color: #2c3e50; margin-top: 10px; }
    #logo { max-width: 200px; margin-bottom: 20px; }
    #filterBar { display:flex; justify-content:center; gap:10px; margin-bottom:15px; flex-wrap:wrap;}
    #filterBar button { padding:8px 14px; border-radius:6px; border:none; cursor:pointer; background:#34495e; color:#fff; font-weight:bold; margin-bottom:10px; min-width:120px;}
    #fileInput, #manualBarcode, button { margin: 10px 0; padding: 10px; font-size: 16px; }
    #camera { width: 95%; max-width: 320px; border: 2px solid #3498db; border-radius: 8px; margin: 10px auto; height: 200px; display:none; }
    #productList { margin-top: 20px; text-align: left; }
    .item { display: flex; flex-direction: column; padding: 12px; margin: 6px 0; border: 2px solid #ddd; background-color: #fdfdfd; border-radius: 8px; cursor: pointer; }
    .product-header { display: flex; justify-content: space-between; font-size: 17px; color:#2c3e50; }
    .product-header span:nth-child(2) { font-size: 20px; color: #c0392b; font-weight:bold; }
    .branch-status { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .branch-tag { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 14px; }
    .branch-tag.pending { background: #bdc3c7; color: #2c3e50; }
    .branch-tag.approved { background: #27ae60; color: white; }
    .branch-tag.rejected { background: #e74c3c; color: white; }
    .btnfile {
      display: inline-flex; align-items: center; gap: 6px;
      background: #e1eaf6; color: #19406c; border: none;
      padding: 9px 20px; border-radius: 7px; font-weight: bold; font-size: 16px;
      cursor: pointer; box-shadow: 0 0 4px #d3d8de;
      transition: background 0.2s;
    }
    .btnfile:hover { background: #d0def2; }
    .btnfile svg {
      width: 21px; height: 21px; vertical-align: middle;
      margin-right: 3px;
      fill: #2c3e50;
    }
    #searchWrap {
      display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 8px;
    }
    #searchInput {
      width: 240px; max-width:90vw;
      padding: 9px 13px; border-radius: 7px; border: 1.5px solid #b7c6d8;
      font-size: 16px; font-family: inherit;
    }
    #searchBtn {
      padding: 9px 18px; border-radius: 7px; border: none;
      background: #3566d6; color: #fff; font-weight: bold; font-size: 16px; cursor: pointer;
      display:flex; align-items:center; gap:7px;
    }
    #searchBtn svg { width:20px; height:20px; fill:#fff; }
    #searchResults {
      margin:0 auto 7px auto; text-align:left; max-width:380px; font-size:17px; padding:0;
      list-style:none; border-radius:9px; box-shadow:0 1px 6px #d0dae3; background:#fff;
      overflow:hidden; display:none;
      position:relative; z-index:22;
    }
    #searchResults li {
      padding: 12px 10px; cursor: pointer; border-bottom:1px solid #ececec;
      transition:background 0.17s;
    }
    #searchResults li:last-child { border-bottom:none; }
    #searchResults li:hover { background:#e3ecfb; }
    @media (max-width: 600px) {
      #topBtnBar { flex-direction: row; gap: 10px 8px;}
      #topBtnBar button, .btnfile { width: 46%; min-width:120px; margin-bottom: 8px;}
      #filterBar { flex-wrap: wrap; }
      #filterBar button { min-width:120px; font-size:14.5px; }
      #searchInput { width:75vw; }
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div>
    <img id="logo" src="logo.png" alt="Demir Kırtasiye Logo">
    <h1>Demir Kırtasiye Transfer İrsaliye Hazırlama</h1>
  </div>
  <div id="progressBar" style="margin-bottom:14px; font-size:17px; font-weight:bold; color:#34495e;"></div>
  <div id="topBtnBar">
    <button id="loadFromSheetsBtn">Google Sheets'ten Ürünleri Yükle</button>
    <label>
      <input type="file" id="fileInput" accept=".xlsx,.csv" style="display:none;">
      <span class="btnfile">
        <!-- Upload ikon SVG -->
        <svg viewBox="0 0 24 24"><path d="M19 15v4a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 5 17 10"/><line x1="12" y1="5" x2="12" y2="17"/></svg>
        Dosya Seç
      </span>
    </label>
    <button id="startCameraBtn">📷 Kamerayı Aç</button>
    <button id="stopCameraBtn">📷 Kamerayı Kapat</button>
    <button id="switchBtn">📷 Kamerayı Değiştir</button>
    <button id="openSearchBtn">🔍 Barkod/Ad Ara</button>
    <button id="exportBtn" style="background:#ffd700;color:#222;">İlerlemeyi Dışa Aktar</button>
    <button id="importBtn" style="background:#1abc9c;color:#fff;">İlerleme Yükle</button>
  </div>
  <!-- === Arama Alanı === -->
  <div id="searchWrap">
    <input id="searchInput" type="text" placeholder="Barkodun son 6 hanesi veya ürün adı...">
    <button id="searchBtn">
      <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7" stroke="white" stroke-width="2" fill="none"/><line x1="16.5" y1="16.5" x2="21" y2="21" stroke="white" stroke-width="2"/></svg>
      Ara
    </button>
  </div>
  <ul id="searchResults"></ul>
  <input type="text" id="manualBarcode" placeholder="Barkodu yazıp Enter’a bas" onkeypress="if(event.key==='Enter'){checkBarcode(this.value)}"><br>
  <div id="camera" style="display:none;"></div>
  <div id="filterBar">
    <button onclick="filterByBranch('Ataevler')">Ataevler</button>
    <button onclick="filterByBranch('Merkez')">Merkez</button>
    <button onclick="filterByBranch('Fethiye')">Fethiye</button>
    <button onclick="filterByBranch('Topkapı')">Topkapı</button>
    <button onclick="filterByBranch('Depoda Kalan')">Depoda Kalan</button>
    <button onclick="showUnassigned()">Ayrılmadı</button>
    <button onclick="clearFilter()">Tümünü Göster</button>
  </div>
  <div id="productList"></div>
  <!-- (popup ve modaller bir sonraki blokta) -->
  <!-- Ürün Detay Popup -->
  <div id="popupOverlay" style="display:none;">
    <div id="popupContent">
      <h2 id="popupProductName"></h2>
      <h3 id="popupProductDesc"></h3>
      <table id="popupTable"></table>
      <button id="closePopup">Kapat</button>
    </div>
  </div>
  <!-- Hatalı Barkod Popup -->
  <div id="errorOverlay" style="display:none;">
    <div id="errorContent">
      <h2 style="color:#e74c3c;">Ürün Bu İrsaliye Değil!</h2>
      <button onclick="closeErrorPopup()">Kapat</button>
    </div>
  </div>
  <!-- Şube Onay/Red Popup -->
  <div id="branchPopupOverlay" style="display:none;">
    <div id="branchPopupContent">
      <h2 id="branchPopupBranch"></h2>
      <h3 id="branchPopupProduct"></h3>
      <div id="branchQty"></div>
      <button id="branchApprove" class="popup-btn approve">✅ AYIRDIM</button>
      <button id="branchReject" class="popup-btn reject">❌ BEKLİYOR</button><br>
      <button id="closeBranchPopup">Kapat</button>
    </div>
  </div>
  <!-- Export/Import Popup -->
  <div id="exportPopup" style="display:none;">
    <div id="exportContent">
      <h2>İlerlemeyi Dışa Aktar</h2>
      <p>Aşağıdaki veriyi <b>json</b> dosyası olarak kaydedebilirsiniz.</p>
      <textarea id="exportData" style="width:99%;height:110px;"></textarea>
      <br>
      <button onclick="downloadExport()">İndir</button>
      <button onclick="closeExportPopup()">Kapat</button>
    </div>
  </div>
  <div id="importPopup" style="display:none;">
    <div id="importContent">
      <h2>İlerleme Yükle</h2>
      <input type="file" id="importFileInput" accept=".json" style="margin-bottom:12px;"><br>
      <textarea id="importData" style="width:99%;height:110px;" placeholder="Yapıştır veya dosya seç"></textarea>
      <br>
      <button onclick="loadImport()">Yükle</button>
      <button onclick="closeImportPopup()">Kapat</button>
    </div>
  </div>
  <!-- Overwrite / Reset Onayı -->
  <div id="overwritePopup" style="display:none;">
    <div id="overwriteContent">
      <h2>Dikkat!</h2>
      <p>Mevcut işaretlemeler ve ilerleme sıfırlanacak.<br>Devam etmek istediğine emin misin?</p>
      <button id="overwriteYesBtn" style="background:#e74c3c;color:white;">Evet, sıfırla ve devam et</button>
      <button onclick="closeOverwritePopup()">Vazgeç</button>
    </div>
  </div>
  <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
  <audio id="errorSound" src="https://actions.google.com/sounds/v1/alarms/beep_long.ogg"></audio>
<script>
let products = [];
let currentProduct = null;
let selectedBranch = null;
let currentFilter = null;
let unassignedFilter = false;
let barcodeInput = document.getElementById('manualBarcode');
let autoRestartCamera = false;

// Export / Import / LocalStorage
const STORAGE_KEY = "demirkirtasiye_transfer_v1";
document.querySelector('.btnfile').onclick = function(){ document.getElementById('fileInput').click(); };

// EXPORT
document.getElementById('exportBtn').onclick = () => {
  const toExport = {
    products, progressBar: document.getElementById('progressBar').innerHTML
  };
  document.getElementById('exportData').value = JSON.stringify(toExport, null, 2);
  document.getElementById('exportPopup').style.display = 'flex';
};
function closeExportPopup() { document.getElementById('exportPopup').style.display = 'none'; }
function downloadExport() {
  const text = document.getElementById('exportData').value;
  const blob = new Blob([text], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = "irsaliye-ilerleme.json";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// IMPORT
document.getElementById('importBtn').onclick = () => {
  document.getElementById('importData').value = "";
  document.getElementById('importFileInput').value = "";
  document.getElementById('importPopup').style.display = 'flex';
};
function closeImportPopup() { document.getElementById('importPopup').style.display = 'none'; }
function loadImport() {
  let json;
  try {
    json = document.getElementById('importData').value;
    if (!json) return alert("Boş veri!");
    const parsed = JSON.parse(json);
    if (!parsed.products) return alert("Hatalı veri.");
    products = parsed.products;
    renderProducts();
    closeImportPopup();
    saveProgress();
  } catch(e) { alert("Geçersiz veya hatalı json!"); }
}
document.getElementById('importFileInput').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    document.getElementById('importData').value = ev.target.result;
  };
  reader.readAsText(file, "UTF-8");
}
function saveProgress() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify({products})); } catch(e){}
}
function loadProgress() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return;
    const obj = JSON.parse(data);
    if(obj.products) {
      products = obj.products;
      renderProducts();
    }
  } catch(e){}
}

// DOSYA YÜKLEME
let pendingFileLoad = null;
document.getElementById('fileInput').addEventListener('change', function(event) {
  if (products.length > 0) {
    pendingFileLoad = () => handleFile(event);
    openOverwritePopup(() => { handleFile(event); products=[]; });
  } else {
    handleFile(event);
  }
});
function handleFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    let raw = XLSX.utils.sheet_to_json(sheet, {defval: ""});
    const grouped = {};
    raw.forEach(row => {
      const barkod = row.Barkodu || row.BARKODU || row.Barkod;
      if (!barkod) return;
      if (!grouped[barkod]) {
        grouped[barkod] = {
          Barkodu: barkod,
          Adi: row.Adı || row["Stok Adı"] || row.ADI || "",
          Adet: 0,
          Ataevler: 0,
          Merkez: 0,
          Fethiye: 0,
          Topkapı: 0,
          "Depoda Kalan": 0,
          scannedStatus: {}
        };
      }
      grouped[barkod].Adet += Number(row.ADET || row.Adet || 0);
      grouped[barkod].Ataevler += Number(row.Ataevler || row.ATAEVLER || 0);
      grouped[barkod].Merkez += Number(row.Merkez || row.MERKEZ || 0);
      grouped[barkod].Fethiye += Number(row.Fethiye || row.FETHİYE || row.FETHIYE || 0);
      grouped[barkod].Topkapı += Number(row.Topkapı || row.TOPKAPI || 0);
      grouped[barkod]["Depoda Kalan"] += Number(row["Depoda Kalan"] || 0);
    });
    products = Object.values(grouped);
    renderProducts();
    saveProgress();
  };
  reader.readAsArrayBuffer(file);
}

// GOOGLE SHEETS YÜKLEME
document.getElementById('loadFromSheetsBtn').onclick = function() {
  if (products.length > 0) {
    openOverwritePopup(() => { loadFromSheets(); products=[]; });
  } else {
    loadFromSheets();
  }
};
function loadFromSheets() {
  fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRK7MAw7CognKnLh-ez67TDVZBvdgxSNJ5B4P-e2KbHgF2uqnKC4V3atPq485Bqmg/pub?output=csv")
    .then(res => res.text())
    .then(csvText => {
      let parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      let rows = parsed.data;
      const grouped = {};
      rows.forEach(row => {
        function getCI(obj, field) {
          const key = Object.keys(obj).find(k => k.toLowerCase() === field.toLowerCase());
          return key ? obj[key] : "";
        }
        const barkod = getCI(row, 'Barkodu') || getCI(row, 'BARKODU') || getCI(row, 'Barkod');
        if (!barkod) return;
        if (!grouped[barkod]) {
          grouped[barkod] = {
            Barkodu: barkod,
            Adi: getCI(row, 'Adı') || getCI(row, 'Stok Adı') || getCI(row, 'ADI') || getCI(row, 'Stok adı') || "",
            Adet: 0,
            Ataevler: 0,
            Merkez: 0,
            Fethiye: 0,
            Topkapı: 0,
            "Depoda Kalan": 0,
            scannedStatus: {}
          };
        }
        grouped[barkod].Adet += Number(getCI(row, 'ADET') || getCI(row, 'Adet') || 0);
        grouped[barkod].Ataevler += Number(getCI(row, 'Ataevler') || getCI(row, 'ATAEVLER') || 0);
        grouped[barkod].Merkez += Number(getCI(row, 'Merkez') || getCI(row, 'MERKEZ') || 0);
        grouped[barkod].Fethiye += Number(getCI(row, 'Fethiye') || getCI(row, 'FETHİYE') || getCI(row, 'FETHIYE') || 0);
        grouped[barkod].Topkapı += Number(getCI(row, 'Topkapı') || getCI(row, 'TOPKAPI') || 0);
        grouped[barkod]["Depoda Kalan"] += Number(getCI(row, "Depoda Kalan") || 0);
      });
      products = Object.values(grouped);
      renderProducts();
      saveProgress();
    })
    .catch(e => alert("Sheets okuma hatası: " + e));
}
// =================== KAMERA SİSTEMİ – HER ZAMAN AÇIK, SÜREKLİ OKUMA ===================
let html5QrCode = null;
let cameraDevices = [];
let cameraRunning = false;
let currentCameraIndex = 0;

async function getCameraDevices() {
  try {
    cameraDevices = (await Html5Qrcode.getCameras()) || [];
    if (!cameraDevices.length) {
      alert("Kamera bulunamadı!");
      return false;
    }
    return true;
  } catch (e) {
    alert("Kamera erişilemedi!");
    return false;
  }
}

// KAMERA HER ZAMAN AÇIK – OKUTTUKTAN SONRA OTOMATİK TEKRAR BAŞLATIR
async function startCameraAuto() {
  autoRestartCamera = true;
  if (cameraRunning) return;
  if (!await getCameraDevices()) return;
  if (html5QrCode) {
    await html5QrCode.stop().catch(()=>{});
    html5QrCode.clear();
    html5QrCode = null;
  }
  html5QrCode = new Html5Qrcode("camera", false);

  const camId = cameraDevices[currentCameraIndex].id;
  document.getElementById("camera").style.display = "block";
  barcodeInput.blur();
  barcodeInput.setAttribute('readonly', true);

  html5QrCode.start(
    {deviceId: {exact: camId}},
    { fps: 15, qrbox: {width: 220, height: 140}, aspectRatio:1.7 },
    (decodedText) => {
      // OKUTUNCA KAMERA KAPANMASIN, TEKRAR OTOMATİK BAŞLASIN
      html5QrCode.stop().then(() => {
        cameraRunning = false;
        document.getElementById("camera").style.display = "block";
        barcodeInput.removeAttribute('readonly');
        checkBarcode(decodedText);
        if (autoRestartCamera) setTimeout(startCameraAuto, 350);
      });
    },
    (errorMessage) => { }
  ).then(() => {
    cameraRunning = true;
    setTimeout(()=>barcodeInput.blur(), 250);
  }).catch(err => {
    alert("Kamera başlatılamadı: " + err);
    document.getElementById("camera").style.display = "none";
    cameraRunning = false;
    barcodeInput.removeAttribute('readonly');
  });
}
document.getElementById('startCameraBtn').onclick = startCameraAuto;
document.getElementById('stopCameraBtn').onclick = async () => {
  autoRestartCamera = false;
  if (html5QrCode && cameraRunning) {
    await html5QrCode.stop();
    html5QrCode.clear();
    html5QrCode = null;
    cameraRunning = false;
    document.getElementById("camera").style.display = "none";
    barcodeInput.removeAttribute('readonly');
    safeFocusBarcodeInput();
  }
};
document.getElementById('switchBtn').onclick = async () => {
  if (!await getCameraDevices()) return;
  if (cameraDevices.length < 2) {
    alert("Başka kamera yok.");
    return;
  }
  if (cameraRunning && html5QrCode) {
    await html5QrCode.stop();
    html5QrCode.clear();
    html5QrCode = null;
    cameraRunning = false;
    document.getElementById("camera").style.display = "none";
  }
  currentCameraIndex = (currentCameraIndex + 1) % cameraDevices.length;
  setTimeout(startCameraAuto, 350);
};

function safeFocusBarcodeInput() {
  if (cameraRunning) return;
  if (!isMobile()) {
    barcodeInput.focus();
  } else {
    barcodeInput.blur();
  }
}
function isMobile() {
  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
}
window.onload = function() {
  loadProgress();
  safeFocusBarcodeInput();
}

// =================== ÜRÜN LİSTELEME, RENDER, FİLTRELER ===================
function renderProducts() {
  const container = document.getElementById('productList');
  container.innerHTML = '';
  const branches = ["Ataevler", "Merkez", "Fethiye", "Topkapı", "Depoda Kalan"];
  let barHtml = '';
  branches.forEach(branch => {
    const filtered = products.filter(p => p[branch] && p[branch] > 0);
    const total = filtered.length;
    const approved = filtered.filter(p => p.scannedStatus[branch] === 'approved').length;
    const percent = total ? Math.round((approved/total)*100) : 0;
    const done = approved === total && total > 0;
    barHtml += `<span style="margin-right:16px;">
      <b>${branch}:</b>
      <span class="branch-progress-bar${done?' done':''}">
        <span class="branch-progress-fill" style="width:${percent}%;background:${done?'#26d07c':'#27ae60'}"></span>
      </span>
      <span class="branch-progress-label">${approved}/${total} (%${percent})${done?" ✔️":""}</span>
    </span>`;
  });
  document.getElementById('progressBar').innerHTML = barHtml;
  products.forEach(p => {
    if (currentFilter && (!p[currentFilter] || p[currentFilter] === 0)) return;
    if (unassignedFilter) {
      const hasPending = Object.keys(p.scannedStatus).length === 0 || Object.values(p.scannedStatus).includes('pending');
      if (!hasPending) return;
    }
    const div = document.createElement('div');
    div.className = 'item';
    div.onclick = () => openPopup(p);
    const headerDiv = document.createElement('div');
    headerDiv.className = 'product-header';
    headerDiv.innerHTML = `<span>${p.Barkodu} - ${p.Adi}</span><span>${p.Adet} ADET</span>`;
    div.appendChild(headerDiv);
    const branchDiv = document.createElement('div');
    branchDiv.className = 'branch-status';
    branches.forEach(branch => {
      if (p[branch] && p[branch] > 0) {
        const status = p.scannedStatus[branch] || 'pending';
        const span = document.createElement('span');
        span.className = `branch-tag ${status}`;
        span.textContent = `${branch}: ${p[branch]}`;
        branchDiv.appendChild(span);
      }
    });
    div.appendChild(branchDiv);
    let allApproved = branches.every(branch => (!p[branch] || p.scannedStatus[branch] === 'approved'));
    let anyRejected = branches.some(branch => p.scannedStatus[branch] === 'rejected');
    if (allApproved) div.classList.add('complete');
    else if (anyRejected) div.classList.add('incomplete');
    container.appendChild(div);
  });
  saveProgress();
}
function filterByBranch(branch) {
  currentFilter = branch;
  unassignedFilter = false;
  renderProducts();
}
function clearFilter() {
  currentFilter = null;
  unassignedFilter = false;
  renderProducts();
}
function showUnassigned() {
  unassignedFilter = true;
  currentFilter = null;
  renderProducts();
}

// =================== POPUP & İŞARETLEME ===================
function openPopup(product) {
  currentProduct = product;
  document.getElementById('popupProductName').textContent = `Barkod: ${product.Barkodu}`;
  document.getElementById('popupProductDesc').textContent = product.Adi;
  let popupTable = document.getElementById('popupTable');
  popupTable.innerHTML = '';
  ["Ataevler","Merkez","Fethiye","Topkapı","Depoda Kalan"].forEach(branch => {
    if (product[branch] && product[branch] > 0) {
      const tr = document.createElement('tr');
      const status = product.scannedStatus[branch] || 'pending';
      tr.className = (status === 'approved') ? 'approved-row' : 'pending-row';
      tr.style.cursor = 'pointer';
      tr.onclick = () => openBranchPopup(product, branch);
      const tdLabel = document.createElement('td');
      tdLabel.textContent = branch;
      const tdQty = document.createElement('td');
      tdQty.textContent = (product[branch] || 0) + " ADET";
      tr.appendChild(tdLabel);
      tr.appendChild(tdQty);
      popupTable.appendChild(tr);
    }
  });
  document.getElementById('popupOverlay').style.display = 'flex';
}
function openBranchPopup(product, branch) {
  selectedBranch = branch;
  currentProduct = product;
  document.getElementById('branchPopupBranch').textContent = branch.toUpperCase();
  document.getElementById('branchPopupProduct').textContent = `${product.Barkodu} - ${product.Adi}`;
  document.getElementById('branchQty').textContent = (product[branch] || 0) + " ADET";
  document.getElementById('branchPopupOverlay').style.display = 'flex';
}
document.getElementById('branchApprove').onclick = () => {
  if (currentProduct && selectedBranch) {
    currentProduct.scannedStatus[selectedBranch] = 'approved';
    renderProducts();
    document.getElementById('branchPopupOverlay').style.display = 'none';
    document.getElementById('popupOverlay').style.display = 'none';
    safeFocusBarcodeInput();
    if (autoRestartCamera) setTimeout(startCameraAuto, 350);
  }
};
document.getElementById('branchReject').onclick = () => {
  if (currentProduct && selectedBranch) {
    currentProduct.scannedStatus[selectedBranch] = 'rejected';
    renderProducts();
    document.getElementById('branchPopupOverlay').style.display = 'none';
    document.getElementById('popupOverlay').style.display = 'none';
    safeFocusBarcodeInput();
    if (autoRestartCamera) setTimeout(startCameraAuto, 350);
  }
};
document.getElementById('closePopup').onclick = () => {
  document.getElementById('popupOverlay').style.display = 'none';
  safeFocusBarcodeInput();
  if (autoRestartCamera) setTimeout(startCameraAuto, 350);
};
document.getElementById('closeBranchPopup').onclick = () => {
  document.getElementById('branchPopupOverlay').style.display = 'none';
  safeFocusBarcodeInput();
  if (autoRestartCamera) setTimeout(startCameraAuto, 350);
};

// Overwrite / Reset Popup
function openOverwritePopup(action) {
  document.getElementById('overwritePopup').style.display = "flex";
  document.getElementById('overwriteYesBtn').onclick = function() {
    document.getElementById('overwritePopup').style.display = "none";
    action();
  }
}
function closeOverwritePopup() {
  document.getElementById('overwritePopup').style.display = "none";
}

// Barkod okuma & hata popup
function checkBarcode(code) {
  const found = products.find(p => p.Barkodu == code || (code.length === 6 && p.Barkodu && p.Barkodu.endsWith(code)));
  if (found) {
    openPopup(found);
    document.getElementById('successSound').volume = 1.0;
    document.getElementById('successSound').play();
  } else {
    document.getElementById('errorOverlay').style.display = 'flex';
    document.getElementById('errorSound').volume = 1.0;
    document.getElementById('errorSound').play();
    if (autoRestartCamera) setTimeout(startCameraAuto, 350);
  }
  barcodeInput.value = '';
  if (!cameraRunning) barcodeInput.focus();
}
function closeErrorPopup(){
  document.getElementById('errorOverlay').style.display = 'none';
  safeFocusBarcodeInput();
  if (autoRestartCamera) setTimeout(startCameraAuto, 350);
}
// =================== AKILLI ARAMA ALANI (SON 6 HANEDEN VE ÜRÜN ADI) ===================
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const searchResults = document.getElementById('searchResults');

// Her inputta sonuçlar güncellenir
searchInput.oninput = function() {
  renderSearchResults(this.value);
};
searchBtn.onclick = function() {
  renderSearchResults(searchInput.value);
};
searchInput.onkeypress = function(e) {
  if (e.key === "Enter" && searchResults.firstChild) {
    searchResults.firstChild.click();
  }
};

// Sonuçları listele ve tıklanınca popup aç
function renderSearchResults(val) {
  let v = (val||"").trim().toLowerCase();
  searchResults.innerHTML = "";
  let filtered = products.filter(p =>
    (p.Barkodu && (p.Barkodu === v || (v.length === 6 && p.Barkodu.endsWith(v)))) ||
    (p.Adi && p.Adi.toLowerCase().includes(v))
  );
  if (!v || !filtered.length) {
    searchResults.style.display = "none";
    searchResults.innerHTML = "";
    return;
  }
  searchResults.style.display = "block";
  filtered.slice(0, 15).forEach(p => {
    let li = document.createElement("li");
    li.innerHTML = `<b>${p.Barkodu}</b> - ${p.Adi}`;
    li.onclick = () => {
      searchResults.style.display="none";
      openPopup(p);
    };
    searchResults.appendChild(li);
  });
  // Sonuç yoksa mesaj
  if (filtered.length === 0) {
    let li = document.createElement("li");
    li.textContent = "Ürün bulunamadı";
    searchResults.appendChild(li);
  }
}

// Arama alanı dışına tıklanınca kapat
document.addEventListener('click', function(e){
  if (!searchResults.contains(e.target) && e.target !== searchInput && e.target !== searchBtn) {
    searchResults.style.display = "none";
  }
});

</script>
</body>
</html>
